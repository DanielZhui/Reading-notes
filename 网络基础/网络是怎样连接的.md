# 网络是怎样连接的

## 浏览器生成的消息 —— 探索浏览器内部

### 生产 HTTP 请求消息

### 向 DNS 服务器查询 Web 服务器的 IP 地址

#### IP 地址的基础知识

​    生成 HTTP 消息之后，接下来我们需要委托操作系统将消息发送给 Web 服务器【浏览器能够解析网址并生成 HTTP 消息，但它本身不具备发到网络的功能】，在进行这一操作时，我们还有一个工作需要完成，就是查询网址中服务器域名对应的 IP 地址。在委托操作系统发送消息时，必须要提供请求服务器的 IP 地址。因此下一个步骤是根据域名查询 IP 地址。

​	互联网和公司内部的局域网都是基于 TCP/IP 的思路来设计的，所以我们需要先了解 TCP/IP 的基本思路，如下图所示。

​	在网络中，所有的设备都会被分配一个地址。这个地址就相当于现实中某条路上的 xx号xx室。其中 号 对应的号码是分配给整个子网的，而 室 对应的号码是分配给子网中的计算机的，这就是网络中的地址。号 对应的号码称为网络号，室 对应的号码称为主机号，这个地址整体称为 IP 地址。通过 IP 地址我们可以判断出访问对象服务器的位置，从而将消息发送到服务器。

![image-20220308220121337](http://static.wollens.top/image-20220308220121337.png)

实际 IP 地址是一串 32 比特的数字，按照 8 比特（1个字节）为一组分成四组，分别用十进制表示然后再用圆点隔开。这就是我们平时常见的 IP 地址格式，但是仅凭一串数字我们无法区分那部分是网络号，那部分是主机号。在 IP 地址的规则中，网络号和主机号连起来共识 32 比特，蛋这两部分的具体结构是不固定的。在组建网络是，用户可以自行决定它们之间的分配关系，因此我们还需要另外的附加信息来表示 IP 地址的内部结构

<img src="http://static.wollens.top/image-20220308221224656.png" alt="image-20220308221224656" style="zoom:50%;" />

子网掩码的格式如下图所示，是一串与 IP 地址长度相同的 32 比特数字，其左边一半都是1，右边一半都是0。其中子网掩码为 1 的部分表示网络号，子网掩码为 0 的部分表示主机号。

<img src="http://static.wollens.top/image-20220308222308302.png" alt="image-20220308222308302" style="zoom:50%;" />

> 备注：主机号部分的比特全部为 0 或者全部为 1 时代表两种特许的含义。主机号部分全部为 0 代表整个子网而不是子网中的某台设备。主机号全部为1代表向子网上所有的设备发送包，即广播



#### 域名和IP地址并用的理由

​	TCP/IP 网络是通过 IP 地址来确定通信的对象，因此不知道 IP 地址就无法将消息发送给对方，因此，在委托操作系统发送消息是，必须要先查询号对方的 IP 地址。

​	既然需要通过域名来查找服务器 IP，那为啥不直接使用 IP 地址访问？实际上，如果用 IP 地址代替服务器名称也是能够正常工作的。然而记一串 IP 地址比较困难，因此相比 IP 地址，网址中使用域名形式访问还是会比较好。

​	现在我们使用的方案是让人来使用名称，让路由器来使用 IP 地址。为了填补两者之间的障碍，需要有一个机制能够通过名称来查询 IP 地址，或者通过 IP 地址来查询名称，这样就能够在任何机器双方都不做出牺牲的前提下完美解决问题，这个机制就是 DNS



#### Socket 库提供查询 IP 地址的功能

​	通过 DNS 查询 IP 地址的操作称为域名解析，因此负责执行解析（resolution）这一操作的就叫做解析器。解析器实际上是一段程序，他饱含在操作系统的 Socket 库中，在介绍解析器之前，我们先来简单了解一下 socket 库。首先，库到底是什么东西？库就是一对通用程序组件的集合，其他的应用程序都需要使用其中的组件。库有很多好处。首先，使用线程的组件搭建应用程序可以节省编程工作量；其次，多个程序使用相同的组件可以实现程序的标准化。Socket 库也是一种库，其中包含的程序组件可以让其他的应用程序调用操作系统的网络功能，而解析器就是合格库中的其中一种程序组件。



#### 通过解析器向 DNS 服务器发出查询

​	解析器的用法非常简单。Socket 库中的程序都是标准组件，只要从应用程序中进行调用就可以。具体来说，在编写浏览器等应用程序的时候，只要想下图所示协商解析器程序名称 "gethostbyname" 以及 Web 服务器的域名 "www.lab.glasscom" 就可以，这样就完成了对解析器的调用。

<img src="http://static.wollens.top/image-20220309153129375.png" alt="image-20220309153129375" style="zoom:50%;" />

​	在应用程序中编写上图中的一行代码后就能够调用解析器完成向 DNS 服务器查询 IP 地址的操作。

​	调用解析器后，解析器会向 DNS 服务器发送查询消息，然后 DNS 服务器会返回相应消息。响应消息中包含查询到的 IP 地址，解析器会取出 IP 地址，并将其写入浏览器指定的内存地址中，只要运行上图中这一行程序，就可以完成前面所有这些工作，我们也就完成了 IP 地址的查询。接下来，浏览器在向 Web 服务器发送消息时，你要从该内存中取出 IP 地址，并将它与 HTTP 请求消息一起交给操作系统就可以。



#### 解析器的内部原理

​	下面来看一看应用程序调用解析器时，解析器内部是如何工作的。解析器内部工作原理如下：

<img src="http://static.wollens.top/image-20220309154012630.png" alt="image-20220309154012630" style="zoom:67%;" />

​	一般来说，应用程序编写的操作内容是从上往下按顺序执行的，当到达需要调用解析器的部分时，对应的那一行程序就会被执行，应用程序本身的工作就会暂停（图1.12①）。然后，Socket库中的解析器开始运行（图1.12②），完成应用程序委托的操作。像这样，由于调用了其他程序，原本运行的程序进入暂停状态，而被调用的程序开始运行，这就是“控制流程转移”[插图]。当控制流程转移到解析器后，解析器会生成要发送给DNS服务器的查询消息。这个过程与浏览器生成要发送给Web服务器的HTTP请求消息的过程类似，解析器会根据DNS的规格，生成一条表示“请告诉我www.lab.glasscom.com的IP地址”[插图]的数据，并将它发送给DNS服务器（图1.12③）。发送消息这个操作并不是由解析器自身来执行，而是要委托给操作系统内部的协议栈[插图]来执行。这是因为和浏览器一样，解析器本身也不具备使用网络收发数据的功能。解析器调用协议栈后，控制流程会再次转移，协议栈会执行发送消息的操作，然后通过网卡将消息发送给DNS服务器（图1.12④⑤）。

​	当DNS服务器收到查询消息后，它会根据消息中的查询内容进行查询。这个查询的过程有点复杂，我们稍后会进行讲解，这里先不关心具体的方法。总之，如果要访问的Web服务器已经在DNS服务器上注册，那么这条记录就能够被找到，然后其IP地址会被写入响应消息并返回给客户端（图1.12⑥）。接下来，消息经过网络到达客户端，再经过协议栈被传递给解析器（图1.12⑦⑧），然后解析器读取出消息取出IP地址，并将IP地址传递给应用程序（图1.12⑨）。实际上，解析器会将取出的IP地址写入应用程序指定的内存地址中，图1.11用“<内存地址>”来表示，在实际的程序代码中应该写的是代表这一内存地址的名称。

​	到这里，解析器的工作就完成了，控制流程重新回到应用程序（浏览器）。现在应用程序已经能够从内存中取出 IP 地址了，所以说 IP 地址是用这种方式传递给应用程序的。

​	计算机中的内部结构是一层一层的，也就是说，很多程序组成不同的层次，彼此之间分工协作，当接到上层委派的操作时，本层的程序并不完成所有的工作，而是会完成一部分工作，再将剩下的部分委派到下层来完成。

​	顺带一提，向 DNS 服务器发送消息时，我嗯当然也需要知道 DNS 服务器的 IP 地址，只不过这个 IP 地址是作为 TCP/IP 的一个设置项目实现设置好的，不需要再去查询。不同操作系统中 TCP/IP 的设置方法也有差异，Windows 中的设置如图所示，解析器会根据这里设置的 DNS 服务器 IP 地址来发送消息

<img src="http://static.wollens.top/image-20220309155212245.png" alt="image-20220309155212245" style="zoom:50%;" />

### 全世界 DNS 服务器大接力

#### DNS 服务器的基本工作

​	前面介绍了解析器与 DNS 服务器之间的交互过程，下面了解一下 DNS 服务器的工作。DNS 服务器的基本工作就是接受来自客户端的查询消息，然后根据消息的内容返回相应

​	其中，来自客户端的查询消息包含一下3中信息

 1. 域名

    服务器、邮件服务器（邮件地址中@后面的部分）的名称

 2. Class

    在最早设计 DNS 方案时，DNS 在互联网以外的其他网络中的应用也被考虑到了，而 Class 就是用来标识网络的信息，不过，如今除了互联网并没有其他的网络了，因此 Class 的值永远是代表互联网的 IN

 3. 记录类型

    表示域名对应何种类型的记录，例如：当类型为 A 时，表示域名对应的是 IP 地址；当类型为 MX 时，表示域名对应的是邮件服务器。对于不同的记录类型，服务器向客户端返回的信息也会不同

​	DNS 服务器上事先保存有前面这 3 种信息对应的记录数据，如下图所示。DNS 服务器就是根据和谐记录查找符合查询请求的内容并对客户端作出相应的

<img src="http://static.wollens.top/image-20220309160117576.png" alt="image-20220309160117576" style="zoom:67%;" />

总结：DNS 服务器的基本工作原理就是根据需要查询的域名和记录类型查找相关的记录，并向客户端返回响应消息。

​	前面只介绍 A 和 MX 这两个记录类型，实际上还有很多其他的类型。例如根据 IP 地址反查域名和 PTR 类型，查询域名相关别名的 CNAME 类型，查询 DNS 服务器 IP 地址的 NS 类型，以及查询域名属性信息的 SOA 类型等。尽管 DNS 服务器的工作原理很简单，不过是根据查询消息中的域名和记录类型来进行查找并返回响应信息而已，但通过组合使用不同的记录类型，就可以处理各种各样的信息。此外，虽然图中展示的是表格形式，但实际上这些信息是保存在配置文件中的，表格中的一行信息被称为一条资源记录。



#### 域名的层次结构

​	互联网中存在着不计其数的服务器，将这些服务器的信息全部保存在一台服务器中是不可能的，因此一定会出现 DNS 服务器找不到要查询的信息的情况。下面来看一看此时 DNS 服务器是如何工作的。

​	直接说出答案其实很简单，就是将信息分布保存在多台 DNS 服务器中，这些 DNS 服务器相互接力配合，从而查出要查询的信息。不过这个机制其实有点复杂，因此我们先来看一看信息是如何在 DNS 服务器上注册保存的。

​	首先，DNS 服务器中的所有信息都是按照区域以分层的结构来保存的。层次结构这个词听起来可能有点不容易懂，其实就是类似公司中的事业集团、部门、科室这样的结构。层次结构能够帮组我们更好的管理大量的信息。

​	DNS中的域名都是用句点来分隔的，比如www.lab.glasscom.com，这里的句点代表了不同层次之间的界限，就相当于公司里面的组织结构不用部、科之类的名称来划分，只是用句点来分隔而已[插图]。在域名中，越靠右的位置表示其层级越高，比如www.lab.glasscom.com这个域名如果按照公司里的组织结构来说，大概就是“com事业集团glasscom部lab科的www”这样。其中，相当于一个层级的部分称为域。因此，com域的下一层是glasscom域，再下一层是lab域，再下面才是www这个名字。

​	DNS中的域名都是用句点来分隔的，比如www.lab.glasscom.com，这里的句点代表了不同层次之间的界限，就相当于公司里面的组织结构不用部、科之类的名称来划分，只是用句点来分隔而已[插图]。在域名中，越靠右的位置表示其层级越高，比如www.lab.glasscom.com这个域名如果按照公司里的组织结构来说，大概就是“com事业集团glasscom部lab科的www”这样。其中，相当于一个层级的部分称为域。因此，com域的下一层是glasscom域，再下一层是lab域，再下面才是www这个名字。



#### 寻找响应的 DNS 服务器并获取 IP 地址

​	下面再来看一看如何找到 DNS 服务器中存放的信息，这里的关键在于如何找到我们要访问的Web服务器的信息跪哪一台DNS服务器管。

​	互联网中有数万台DNS服务器，肯定不能一台一台挨个去找。我们可以采用下面的办法。首先，将负责管理下级域的DNS服务器的IP地址注册到它们的上级DNS服务器中，然后上级DNS服务器的IP地址再注册到更上一级的DNS服务器中，以此类推。也就是说，负责管理lab.glasscom.com这个域的DNS服务器的IP地址需要注册到glasscom.com域的DNS服务器中，而glasscom.com域的DNS服务器的IP地址又需要注册到com域的DNS服务器中。这样，我们就可以通过上级DNS服务器查询出下级DNS服务器的IP地址，也就可以向下级DNS服务器发送查询请求了。

​	在前面的讲解中，似乎com、jp这些域（称为顶级域）就是最顶层了，它们各自负责保存下级DNS服务器的信息，但实际上并非如此。在互联网中，com和jp的上面还有一级域，称为根域。根域不像com、jp那样有自己的名字，因此在一般书写域名时经常被省略，如果要明确表示根域，应该像www.lab.glasscom.com．这样在域名的最后再加上一个句点，而这个最后的句点就代表根域。不过，一般都不写最后那个句点，因此根域的存在往往被忽略，但根域毕竟是真实存在的，根域的DNS服务器中保管着com、jp等的DNS服务器的信息。由于上级DNS服务器保管着所有下级DNS服务器的信息，所以我们可以从根域开始一路往下顺藤摸瓜找到任意一个域的DNS服务器。

​	除此之外还需要完成另一项工作，那就是将根域的DNS服务器信息保存在互联网中所有的DNS服务器中。这样一来，任何DNS服务器就都可以找到并访问根域DNS服务器了。因此，客户端只要能够找到任意一台DNS服务器，就可以通过它找到根域DNS服务器，然后再一路顺藤摸瓜找到位于下层的某台目标DNS服务器（图1.15）。分配给根域DNS服务器的IP地址在全世界仅有13个[插图]，而且这些地址几乎不发生变化，因此将这些地址保存在所有的DNS服务器中也并不是一件难事。实际上，根域DNS服务器的相关信息已经包含在DNS服务器程序的配置文件中了，因此只要安装了DNS服务器程序，这些信息也就被自动配置好了。

​	到这里所有的准备工作都完成了，当我们配置一台 DNS 服务器时，必须要配置好上面这些信息，这样 DNS 服务器就能够从上万台 DNS 服务器中找到目标服务器。下图展示这个过程是如何进行的

<img src="http://static.wollens.top/image-20220309170832901.png" alt="image-20220309170832901" style="zoom:50%;" />

​	如下图所示：客户端首先会访问最近的一台DNS服务器（也就是客户端的TCP/IP设置中填写的DNS服务器地址），假设我们要查询www.lab.glasscom.com这台Web服务器的相关信息（图1.16①）。由于最近的DNS服务器中没有存放www.lab.glasscom.com这一域名对应的信息，所以我们需要从顶层开始向下查找。最近的DNS服务器中保存了根域DNS服务器的信息，因此它会将来自客户端的查询消息转发给根域DNS服务器（图1.16②）。根域服务器中也没有www.lab.glasscom.com这个域名，但根据域名结构可以判断这个域名属于com域，因此根域DNS服务器会返回它所管理的com域中的DNS服务器的IP地址，意思是“虽然我不知道你要查的那个域名的地址，但你可以去com域问问看”。接下来，最近的DNS服务器又会向com域的DNS服务器发送查询消息（图1.16③）。com域中也没有www.lab.glasscom.com这个域名的信息，和刚才一样，com域服务器会返回它下面的glasscom.com域的DNS服务器的IP地址。以此类推，只要重复前面的步骤，就可以顺藤摸瓜找到目标DNS服务器（图1.16⑤），只要向目标DNS服务器发送查询消息，就能够得到我们需要的答案，也就是www.lab.glasscom.com的IP地址了。

![image-20220309171052934](http://static.wollens.top/image-20220309171052934.png)

​	收到客户端的查询消息之后，DNS服务器会按照前面的方法来查询IP地址，并返回给客户端（图1.16⑥）。这样，客户端就知道了Web服务器的IP地址，也就能够对其进行访问了（图1.16⑦）



#### 通过缓存加快 DNS 服务器的响应

​	图1.16展示的是基本原理，与真实互联网中的工作方式还是有一些区别的。在真实的互联网中，一台DNS服务器可以管理多个域的信息，因此并不是像图1.16这样每个域都有一台自己的DNS服务器。图中，每一个域旁边都写着一台DNS服务器，但现实中上级域和下级域有可能共享同一台DNS服务器。在这种情况下，访问上级DNS服务器时就可以向下跳过一级DNS服务器，直接返回再下一级DNS服务器的相关信息。

​	此外，有时候并不需要从最上级的根域开始查找，因为DNS服务器有一个缓存[插图]功能，可以记住之前查询过的域名。如果要查询的域名和相关信息已经在缓存中，那么就可以直接返回响应，接下来的查询可以从缓存的位置开始向下进行。相比每次都从根域找起来说，缓存可以减少查询所需的时间。并且，当要查询的域名不存在时，“不存在”这一响应结果也会被缓存。这样，当下次查询这个不存在的域名时，也可以快速响应。

​	这个缓存机制中有一点需要注意，那就是信息被缓存后，原本的注册信息可能会发生改变，这时缓存中的信息就有可能是不正确的。因此，DNS服务器中保存的信息都设置有一个有效期，当缓存中的信息超过有效期后，数据就会从缓存中删除。而且，在对查询进行响应时，DNS服务器也会告知客户端这一响应的结果是来自缓存中还是来自负责管理该域名的DNS服务器。



### 委托协议栈发送消息

